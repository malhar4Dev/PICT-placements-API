<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VISUALISE</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link rel="stylesheet" href="data.css">

</head>

<body>
  <header class="bg-white shadow-sm py-3">
    <div class="container d-flex justify-content-between align-items-center" id="navbar">
      <!-- Logo and Title -->
      <div class="d-flex align-items-center" id="logo">
        <!-- <img src="Screenshot.png" alt="Logo" class="me-2 logo-img"> -->
        <span class="fs-5 fw-bold">PLACEMENT WEBSITE</span>
      </div>
      <!-- Navigation and Search Bar -->
      <nav class="d-flex align-items-center">
        <div class="search-container me-3">
          <input id="search-input" type="search" class="form-control me-2" placeholder="Search...">
          <button id="search-button" type="button" class="btn btn-primary">
            <i class="fas fa-search"></i>
          </button>
        </div>
        <a href="home.html" class="nav-link">HOME</a>
        <a href="visualise.html" class="nav-link">VISUALISE</a>
        <a href="#faq" class="nav-link">FAQ</a>
        <a href="#login" class="nav-link">ABOUT US</a>
        <form action="/amazon.html">
          <button type="submit" class="btn btn-primary rounded-pill px-4">Get Started</button>
        </form>
      </nav>
    </div>
  </header>
  <section>

    <div class="rect">
      <div>
        <h2>Analyse the data using our API</h2>
      </div>
      <form id="analyseForm" method="GET">
        <div class="selectors">
          <div class="button">
            <input type="text" placeholder="year" spellcheck="true" list="years" required>
            <datalist id="years">
              <!-- the suggestions should appear here -->
              <option value="all years"></option>
              <option value="2019 -20"></option>
              <option value="2020 -21"></option>
              <option value="2021 -22"></option>
              <option value="2022 -23"></option>
              <option value="2023 -24"></option>
              <option value="2024 -25"></option>
            </datalist>
          </div>

          <div class="button">
            <input type="text" placeholder="select company" spellcheck="true" list="compnames" required>
            <!-- this datalist is used for providing the options for above input text. -->
            <datalist id="compnames">
              <!-- the suggestions should appear here -->
              <option value="all companies"></option>

            </datalist>

          </div>

          <div class="button">
            <input type="text" placeholder="skills" spellcheck="true" list="skillset">
            <datalist id="skillset">
              <!-- the suggestions should appear here -->
              <option value="all skills"></option>
              <option value="DSA"></option>
              <option value="Development"></option>
              <option value="Apptitude"></option>


            </datalist>
          </div>
        </div>
        <div class="button">

          <button type="submit">Analyse it</button>

        </div>
      </form>
      <div class="generated">
        <div class="chart-container">
          <canvas id="placementChart" width="400" height="200"></canvas>
        </div>
        <div class="lpa">
          <h2 style="font-size: larger;">Salary offered : </h2>
          <h2 style="font-size: larger;" id="lpa_num"> X LPA </h2>
        </div>
        <div class="skill_set">
          here it should display the skillset required
        </div>
      </div>

    </div>


  </section>

  <script>
    const form = document.getElementById('analyseForm');
    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      const year = document.querySelector('input[list="years"]').value;
      const company = document.querySelector('input[list="compnames"]').value;

      if (!year) {
        alert('Please select a year.');
        return;
      }
      if (year == 'all years') {
        alert('Please select a single year.');
        return;
      }
      if (!company) {
        alert('Please select a company.');
        return;
      }

      try {
        // Fetch filtered data
        const response = await fetch(`/filtered_data?year=${year}&Company_name=${company}`);
        const { data, chartData } = await response.json();

        // Handle the case where chartData is available
        if (chartData) {
          renderChart(chartData.maleCount, chartData.femaleCount);
        } else {
          alert('Chart data is only available for a single company in a single year.');
        }
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    });

    function renderChart(maleCount, femaleCount) {
      const ctx = document.getElementById('placementChart').getContext('2d');

      // Destroy the previous chart instance (if any)
      if (window.myChart) {
        window.myChart.destroy();
      }

      // Create a new chart
      window.myChart = new Chart(ctx, {
        type: 'bar', // Use 'bar' if you prefer
        data: {
          labels: ['Male', 'Female'],
          datasets: [
            {
              label: 'Students Placed',
              data: [maleCount, femaleCount],
              backgroundColor: ['#4CAF50', '#FF6384'],
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
          },
        },
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const yearInput = document.querySelector('input[list="years"]');
      const compInput = document.querySelector('input[list="compnames"]');
      compInput.disabled = false; // Disable company name input by default

      if (yearInput) {
        yearInput.addEventListener('change', fetchCompany);
      } else {
        console.error('Year input not found.');
      }

      // Alert if company name is selected without selecting a year first
      compInput.addEventListener('focus', function () {
        const yearInputValue = document.querySelector('input[list="years"]').value;
        if (!yearInputValue) {
          console.log("select year!")
          alert('Please select the year first!');
          compInput.disabled = true;  // Disable company input until a year is selected
        }
      });
    });




    async function fetchCompany() {
      const yearInput = document.querySelector('input[list="years"]').value;
      const compInput = document.querySelector('input[list="compnames"]');
      if (!yearInput) {
        compInput.disabled = true; // Disable if no year is selected
        return;
      }

      try {
        const response = await fetch(`/cnames?year=${yearInput}`);
        const info = await response.json();

        const nameoptions = document.getElementById('compnames');
        nameoptions.innerHTML = ''; // Clear previous options
        nameoptions.innerHTML = '<option>all companies</option>';

        if (info.length === 0) {
          alert("no data found for this year")
          compInput.disabled = true; // Disable if no companies are returned
        } else {
          info.forEach(company => {
            const names = `<option>${company.Company_name}</option>`;
            nameoptions.innerHTML += names;
          });
          compInput.disabled = false; // Enable if data is returned
        }
      } catch (error) {
        console.error('Error fetching companies:', error);
        compInput.disabled = true; // Disable if there's an error fetching data
      }
    }

    async function fetchlpa() {
      const year = document.querySelector('input[list="years"]').value;
      const company = document.querySelector('input[list="compnames"]').value;

      try {
        const response = await fetch(`/lpa?year=${year}&Company_name=${company}`);
        const data = await response.json();

        // Display the fetched LPA
        const lpaDisplay = document.getElementById('lpa_num');
        lpaDisplay.innerHTML = data.length > 0
          ? `LPA: ${data[0].sal_lpa}`
          : 'No data found for the selected filters.';
      } catch (error) {
        console.error('Error fetching LPA data:', error);
      }
    }

  </script>
</body>

</html>